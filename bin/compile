#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ANT_VER="1.8.3"

#if [ "true" == $KEEP_M2_CACHE ]; then
#  logger -p user.notice -t "slugc[$$]" "language_pack_java retain_m2_repo"
#fi

#create the cache dir if it doesn't exist
mkdir -p $CACHE_DIR

# change to cache dir to install apache ant
cd $CACHE_DIR

# install ant with base repository
ANT_URL="http://apache.mirror1.spango.com/ant/binaries/apache-ant-$ANT_VER-bin.tar.gz"

echo -n "-----> Installing Apache Ant $ANT_VER....."
curl --silent --max-time 60 --location $ANT_URL | tar xz
chmod +x apache-ant-$ANT_VER/bin/ant
echo " done"

# change to build dir to run ant
cd $BUILD_DIR

export ANT_OPTS="-Xmx512m"

# build app
BUILDCMD="$CACHE_DIR/apache-ant-$ANT_VER/bin/ant -Duser.home=$BUILD_DIR clean install"
echo "-----> executing $BUILDCMD"

$BUILDCMD 2>&1 | sed -u 's/^/       /'

if [ "${PIPESTATUS[*]}" != "0 0" ]; then
  echo " !     Failed to build app with Ant"
  exit 1
fi

